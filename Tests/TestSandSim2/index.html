<html>

<head>
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        #container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        canvas {
            border: 1px solid #ccc;
        }
        
        h2 {
            margin-top: 0;
        }
        
        #controls {
            margin-bottom: 20px;
        }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        
        button:hover {
            background: #0056b3;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
    <script src="./out/SandSim.js"></script>
    <script>
        let sandSim;
        let animationId;
        let ballAngle = 0;

        function drawSandTable(canvasId, sandSim) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const size = sandSim.sandTableSideLen;
            const cellWidth = width / size;
            const cellHeight = height / size;

            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            // Draw sand levels as colors
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const sandLevel = sandSim.sandMatrix[y][x];
                    const maxLevel = sandSim.maxSandLevel;

                    // Calculate distance from center for circular visualization
                    const centerX = size / 2;
                    const centerY = size / 2;
                    const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    const maxDist = size / 2;

                    // Only draw within circular boundary
                    if (dist <= maxDist) {
                        // Color based on sand level (brown/tan gradient)
                        const intensity = Math.min(255, Math.floor((sandLevel / maxLevel) * 200 + 55));
                        ctx.fillStyle = `rgb(${intensity}, ${intensity * 0.8}, ${intensity * 0.5})`;
                        ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                    }
                }
            }

            // Draw ball position
            const ballX = sandSim.ballPos.x * cellWidth;
            const ballY = sandSim.ballPos.y * cellHeight;
            const ballRadius = (sandSim.ballDiameter / 2) * cellWidth;
            ctx.fillStyle = 'rgba(255, 0, 0, 0.6)';
            ctx.beginPath();
            ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
            ctx.fill();

            // Draw ball outline
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function getLineAcrossSand(pt1, pt2, sandSim) {
            let axisDistX = Math.abs(pt2.x - pt1.x);
            let axisDistY = Math.abs(pt2.y - pt1.y);
            let maxAxisDist = Math.max(axisDistX, axisDistY);
            let sandLevel = [];
            if (axisDistX >= axisDistY) {
                let incY = (pt2.y - pt1.y) / (pt2.x - pt1.x);
                for (let i = 0; i < maxAxisDist; i++) {
                    let x = Math.floor(pt1.x + i);
                    let y = Math.floor(pt1.y + (i * incY));
                    sandLevel.push(sandSim.sandMatrix[y][x]);
                    // sandLevel.push(i);
                }
            } else {
                let incX = (pt2.x - pt1.x) / (pt2.y - pt1.y);
                for (let i = 0; i < maxAxisDist; i++) {
                    let x = Math.floor(pt1.x + (i * incX));
                    let y = Math.floor(pt1.y + i);
                    sandLevel.push(sandSim.sandMatrix[y][x]);
                }
            }
            return sandLevel;
        }

        function initSandTable() {
            sandSim = new SandSim(10, 100);
            sandSim.placeBallInitially();
            drawSandTable('sandCanvas', sandSim);
            updateChart();
        }

        function updateChart() {
            let sandLevel = getLineAcrossSand({
                x: 0,
                y: 0
            }, {
                x: 99,
                y: 99
            }, sandSim);
            let labels = [];
            for (let i = 0; i < sandLevel.length; i++)
                labels.push(i);

            const ctx = document.getElementById('myChart').getContext('2d');
            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sand Level (Diagonal Slice)',
                        data: sandLevel,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Sand Height'
                            }
                        }],
                        xAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Position'
                            }
                        }]
                    }
                }
            };

            if (window.myLineChart) {
                window.myLineChart.destroy();
            }
            window.myLineChart = new Chart(ctx, config);
        }

        function animateBall() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
                document.getElementById('animateBtn').textContent = 'Start Animation';
                return;
            }

            document.getElementById('animateBtn').textContent = 'Stop Animation';

            function animate() {
                // Move ball in a circle
                ballAngle += 0.02;
                const centerX = sandSim.sandTableSideLen / 2;
                const centerY = sandSim.sandTableSideLen / 2;
                const radius = sandSim.sandTableSideLen / 3;

                const newX = centerX + Math.cos(ballAngle) * radius;
                const newY = centerY + Math.sin(ballAngle) * radius;

                sandSim.ballPos = {
                    x: Math.floor(newX),
                    y: Math.floor(newY)
                };
                sandSim.moveSand(sandSim.ballPos, ballAngle);

                drawSandTable('sandCanvas', sandSim);
                updateChart();

                animationId = requestAnimationFrame(animate);
            }

            animate();
        }

        function resetSandTable() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
                document.getElementById('animateBtn').textContent = 'Start Animation';
            }
            ballAngle = 0;
            initSandTable();
        }
    </script>
</head>

<body onload="initSandTable()">
    <h1>Sand Table Simulator</h1>

    <div id="controls">
        <button id="animateBtn" onclick="animateBall()">Start Animation</button>
        <button onclick="resetSandTable()">Reset</button>
    </div>

    <div id="container">
        <div class="panel">
            <h2>Sand Table (Top View)</h2>
            <canvas id="sandCanvas" width="600" height="600"></canvas>
        </div>

        <div class="panel">
            <h2>Sand Level Profile</h2>
            <canvas id="myChart" width="600" height="400"></canvas>
        </div>
    </div>